import dotenv from 'dotenv';
dotenv.config();

import express from 'express';
import next from 'next';
import pool from './db';

const db = pool;

const dev = process.env.NODE_ENV !== 'production';
const app = next({ dev });
const handle = app.getRequestHandler();

var passport = require('passport');
import strategy from './passport';

passport.use(strategy);


//let bodyParser = require('body-parser');
//app.use(bodyParser.json());
//app.use(bodyParser.urlencoded({ extended: false }));
//
//
	
	db.connect((err: any, client: any, release: any) => {
    if (err) {
      console.error(`Database connection error: ${err.stack}`);
	  return;
    }
    console.log('Database Connected Successfully');
    release();
	});

app.prepare().then(() => {
const server = express();

	

	server.post('api/login/password',
				passport.authenticate('local', { successRedirect: '/dashboard', failureRedirect: '/' }), 
				);

// Next.js page handling
  server.get('*', (req: any, res: any) => {
    return handle(req, res);
  });


const PORT = process.env.PORT || 3000;
server.listen(PORT, (err: any) => {
  if (err) throw err;
  console.log(`> Ready on http://localhost:${PORT}`);
});

});
	});
